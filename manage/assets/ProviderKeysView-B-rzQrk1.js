import{bL as C,_ as h,r as v,a as H,v as I,o as G,c,e as l,w as n,f as s,N as Q,bM as W,h as f,i as o,aB as O,m as d,B as m,p as g,H as X,I as Z,t as y,z as ee,bN as ae,j as te,y as P,l as u,bJ as re,bO as le}from"./index-bpa48Sxk.js";import{f as se}from"./formatters-CqQpRoa5.js";import{u as oe}from"./use-message-CHqbSZtC.js";function ne(p={}){return C.get("/x-keys",{params:p})}function ue(p){return C.post("/x-keys",p)}function j(p,i){return C.put(`/x-keys/${encodeURIComponent(p)}`,i)}function ie(p){return C.delete(`/x-keys/${encodeURIComponent(p)}`)}const de={class:"provider-keys-view"},pe={class:"card-header"},ve={class:"actions"},ce={key:0,class:"keys-table"},fe=["title"],ye=["title"],me={class:"row-actions"},ge={key:1,class:"empty-state"},we={key:0,class:"config-block"},be={key:1,class:"config-block"},xe={key:2,class:"config-block"},Ke={class:"drawer-footer"},ke={__name:"ProviderKeysView",setup(p){const i=oe(),N=v(!1),S=v(!1),U=v([]),_=v(""),b=v(null),w=v(!1),K=v("create"),k=v(null),A=()=>({type:"standard",name:"",provider:"https://api.openai.com",secretKey:"",level:1,status:!0,azure:{modelMapping:"",apiVersions:""},vertex:{baseUrl:"",projectId:"",clientEmail:"",privateKey:""},customConfig:""}),t=H(A()),E=[{label:"标准 (OpenAI / Anthropic)",value:"standard"},{label:"Azure OpenAI",value:"azure"},{label:"Vertex AI",value:"vertex"},{label:"自定义 JSON",value:"custom"}],D=I(()=>K.value==="create"?"新增 Provider 密钥":"编辑 Provider 密钥"),R=I(()=>[...new Set(U.value.map(e=>e.level))].sort((e,a)=>e-a).map(e=>({label:`Level ${e}`,value:e}))),M=I(()=>{let r=U.value;b.value!==null&&b.value!==void 0&&(r=r.filter(a=>a.level===b.value));const e=_.value.trim().toLowerCase();return e&&(r=r.filter(a=>[a.name,a.provider,String(a.id)].some(z=>z?.toString().toLowerCase().includes(e)))),r});G(()=>{x()});function V(){Object.assign(t,A())}function $(r){return r?r.length<=10?r:`${r.substring(0,8)}...${r.substring(r.length-4)}`:"--"}function J(r){return r?se(r,"YYYY-MM-DD HH:mm"):"--"}async function x(){N.value=!0;try{const r=await ne({size:200}),e=Array.isArray(r.data)?r.data:r.data.keys||[];U.value=e.map(a=>({id:a.ID||a.id,name:a.Name||a.name||"--",provider:a.Provider||a.provider,secretKey:a.SecretKey||a.secret_key,level:a.Level||a.level,status:a.Status??a.status??!0,type:a.Config&&typeof a.Config=="object"&&a.Config.provider_type||a.config&&a.config.provider_type||"standard",createdAt:a.CreatedAt||a.created_at,updatedAt:a.UpdatedAt||a.updated_at,raw:a}))}catch(r){const e=r?.response?.data?.message||r?.message||"加载密钥失败";i.error(e)}finally{N.value=!1}}function L(){K.value="create",k.value=null,V(),w.value=!0}function B(r){K.value="edit",k.value=r,V(),t.type=r.type||"standard",t.name=r.name||"",t.provider=r.provider||"",t.level=r.level||1,t.status=r.status??!0,t.secretKey="";const e=r.raw?.config||{};t.type==="azure"&&(t.azure.modelMapping=e.model_mapping?JSON.stringify(e.model_mapping,null,2):"",t.azure.apiVersions=e.api_versions?JSON.stringify(e.api_versions,null,2):""),t.type==="vertex"&&(t.vertex.baseUrl=e.base_url||"",t.vertex.projectId=e.project_id||"",t.vertex.clientEmail=e.client_email||"",t.vertex.privateKey=e.private_key||""),t.type==="custom"&&(t.customConfig=e?JSON.stringify(e,null,2):""),w.value=!0}function q(){if(t.type==="azure"){const r={provider_type:"azure"};return t.azure.modelMapping&&(r.model_mapping=JSON.parse(t.azure.modelMapping)),t.azure.apiVersions&&(r.api_versions=JSON.parse(t.azure.apiVersions)),r}if(t.type==="vertex"){if(!t.vertex.baseUrl||!t.vertex.projectId||!t.vertex.clientEmail||!t.vertex.privateKey)throw new Error("Vertex AI 配置字段不能为空");return{provider_type:"vertex",base_url:t.vertex.baseUrl.trim(),project_id:t.vertex.projectId.trim(),client_email:t.vertex.clientEmail.trim(),private_key:t.vertex.privateKey.trim()}}return t.type==="custom"?t.customConfig.trim()?JSON.parse(t.customConfig):{}:t.type==="standard"?{provider_type:"standard"}:{}}async function T(){try{S.value=!0;const r={SecretKey:t.secretKey?t.secretKey.trim():void 0,Provider:t.provider.trim(),Level:Number(t.level)||1,Name:t.name.trim()||void 0,Status:t.status};let e;try{e=q()}catch(a){throw new Error(a.message||"配置解析失败")}if(Object.keys(e).length>0&&(r.config=e),K.value==="create"){if(!t.secretKey&&t.type!=="vertex"){i.warning("请输入 SecretKey");return}await ue(r),i.success("密钥创建成功")}else k.value&&(r.SecretKey||delete r.SecretKey,await j(k.value.id,r),i.success("密钥更新成功"));w.value=!1,await x()}catch(r){const e=r?.response?.data?.message||r?.message||"保存失败";i.error(e)}finally{S.value=!1}}async function F(r){try{await j(r.id,{Status:!r.status}),i.success(`${r.status?"已禁用":"已启用"}密钥`),await x()}catch(e){const a=e?.response?.data?.message||e?.message||"更新失败";i.error(a)}}async function Y(r){if(window.confirm(`确定删除密钥 ${r.name||r.id} 吗？此操作不可撤销。`))try{await ie(r.id),i.success("密钥已删除"),await x()}catch(e){const a=e?.response?.data?.message||e?.message||"删除失败";i.error(a)}}return(r,e)=>(f(),c("section",de,[l(s(Q),{class:"keys-card",bordered:!1},{default:n(()=>[o("header",pe,[e[19]||(e[19]=o("div",null,[o("h2",null,"Provider 密钥"),o("p",null,"统一查看、筛选、编辑上游模型密钥，支持类型化配置。")],-1)),o("div",ve,[l(s(O),{value:b.value,"onUpdate:value":e[0]||(e[0]=a=>b.value=a),size:"small",placeholder:"Level 筛选",clearable:"",options:R.value,style:{width:"140px"}},null,8,["value","options"]),l(s(d),{value:_.value,"onUpdate:value":e[1]||(e[1]=a=>_.value=a),size:"small",placeholder:"搜索名称 / Provider",clearable:"",style:{width:"220px"}},null,8,["value"]),l(s(m),{secondary:"",size:"small",loading:N.value,onClick:x},{default:n(()=>[...e[17]||(e[17]=[g("刷新",-1)])]),_:1},8,["loading"]),l(s(m),{type:"primary",size:"small",onClick:L},{default:n(()=>[...e[18]||(e[18]=[g("新增密钥",-1)])]),_:1})])]),M.value.length?(f(),c("div",ce,[e[22]||(e[22]=o("div",{class:"table-head"},[o("span",null,"ID"),o("span",null,"名称"),o("span",null,"Provider"),o("span",null,"SecretKey"),o("span",null,"Level"),o("span",null,"状态"),o("span",null,"创建时间"),o("span")],-1)),(f(!0),c(X,null,Z(M.value,a=>(f(),c("div",{key:a.id,class:"table-row"},[o("span",null,y(a.id),1),o("span",null,y(a.name),1),o("span",{class:"truncate",title:a.provider},y(a.provider),9,fe),o("span",{class:"truncate secret-key",title:a.secretKey},y($(a.secretKey)),9,ye),o("span",null,y(a.level),1),o("span",null,[o("span",{class:ee(["status",a.status?"online":"offline"])},y(a.status?"启用":"禁用"),3)]),o("span",null,y(J(a.createdAt)),1),o("span",me,[l(s(m),{text:"",size:"small",onClick:z=>B(a)},{default:n(()=>[...e[20]||(e[20]=[g("编辑",-1)])]),_:1},8,["onClick"]),l(s(m),{text:"",size:"small",onClick:z=>F(a)},{default:n(()=>[g(y(a.status?"禁用":"启用"),1)]),_:2},1032,["onClick"]),l(s(m),{text:"",size:"small",type:"error",onClick:z=>Y(a)},{default:n(()=>[...e[21]||(e[21]=[g("删除",-1)])]),_:1},8,["onClick"])])]))),128))])):(f(),c("div",ge,[...e[23]||(e[23]=[o("p",null,"暂无密钥记录，点击右上角“新增密钥”开始配置。",-1)])]))]),_:1}),l(s(W),{show:w.value,"onUpdate:show":e[16]||(e[16]=a=>w.value=a),width:480,placement:"right","trap-focus":!1},{default:n(()=>[l(s(ae),{title:D.value,closable:""},{footer:n(()=>[o("div",Ke,[l(s(m),{tertiary:"",onClick:e[15]||(e[15]=a=>w.value=!1)},{default:n(()=>[...e[27]||(e[27]=[g("取消",-1)])]),_:1}),l(s(m),{type:"primary",loading:S.value,onClick:T},{default:n(()=>[...e[28]||(e[28]=[g("保存",-1)])]),_:1},8,["loading"])])]),default:n(()=>[l(s(te),{"label-placement":"top",model:t,class:"drawer-form"},{default:n(()=>[l(s(u),{label:"类型",required:""},{default:n(()=>[l(s(O),{value:t.type,"onUpdate:value":e[2]||(e[2]=a=>t.type=a),options:E,placeholder:"选择 Provider 类型"},null,8,["value"])]),_:1}),l(s(u),{label:"名称"},{default:n(()=>[l(s(d),{value:t.name,"onUpdate:value":e[3]||(e[3]=a=>t.name=a),placeholder:"用于区分的别名"},null,8,["value"])]),_:1}),l(s(u),{label:"Provider 地址",required:""},{default:n(()=>[l(s(d),{value:t.provider,"onUpdate:value":e[4]||(e[4]=a=>t.provider=a),placeholder:"https://api.openai.com"},null,8,["value"])]),_:1}),l(s(u),{label:"SecretKey"},{default:n(()=>[l(s(d),{value:t.secretKey,"onUpdate:value":e[5]||(e[5]=a=>t.secretKey=a),placeholder:"sk-...",type:"password","show-password-on":"click"},null,8,["value"])]),_:1}),l(s(u),{label:"Level",required:""},{default:n(()=>[l(s(re),{value:t.level,"onUpdate:value":e[6]||(e[6]=a=>t.level=a),min:1,max:99},null,8,["value"])]),_:1}),l(s(u),{label:"状态"},{default:n(()=>[l(s(le),{value:t.status,"onUpdate:value":e[7]||(e[7]=a=>t.status=a)},null,8,["value"])]),_:1}),t.type==="azure"?(f(),c("div",we,[e[24]||(e[24]=o("h4",null,"Azure 配置",-1)),l(s(u),{label:"Model Mapping (JSON)"},{default:n(()=>[l(s(d),{value:t.azure.modelMapping,"onUpdate:value":e[8]||(e[8]=a=>t.azure.modelMapping=a),type:"textarea",placeholder:'{"gpt-4":"azure-deployment"}',autosize:{minRows:3,maxRows:6}},null,8,["value"])]),_:1}),l(s(u),{label:"API Versions (JSON)"},{default:n(()=>[l(s(d),{value:t.azure.apiVersions,"onUpdate:value":e[9]||(e[9]=a=>t.azure.apiVersions=a),type:"textarea",placeholder:'{"gpt-4":"2024-02-01"}',autosize:{minRows:3,maxRows:6}},null,8,["value"])]),_:1})])):P("",!0),t.type==="vertex"?(f(),c("div",be,[e[25]||(e[25]=o("h4",null,"Vertex AI 配置",-1)),l(s(u),{label:"Base URL",required:""},{default:n(()=>[l(s(d),{value:t.vertex.baseUrl,"onUpdate:value":e[10]||(e[10]=a=>t.vertex.baseUrl=a),placeholder:"https://us-central1-aiplatform.googleapis.com"},null,8,["value"])]),_:1}),l(s(u),{label:"Project ID",required:""},{default:n(()=>[l(s(d),{value:t.vertex.projectId,"onUpdate:value":e[11]||(e[11]=a=>t.vertex.projectId=a),placeholder:"your-project-id"},null,8,["value"])]),_:1}),l(s(u),{label:"Service Account Email",required:""},{default:n(()=>[l(s(d),{value:t.vertex.clientEmail,"onUpdate:value":e[12]||(e[12]=a=>t.vertex.clientEmail=a),placeholder:"service-account@project.iam.gserviceaccount.com"},null,8,["value"])]),_:1}),l(s(u),{label:"Private Key",required:""},{default:n(()=>[l(s(d),{value:t.vertex.privateKey,"onUpdate:value":e[13]||(e[13]=a=>t.vertex.privateKey=a),type:"textarea",placeholder:"-----BEGIN PRIVATE KEY-----",autosize:{minRows:4,maxRows:6}},null,8,["value"])]),_:1})])):P("",!0),t.type==="custom"?(f(),c("div",xe,[e[26]||(e[26]=o("h4",null,"自定义配置 (JSON)",-1)),l(s(u),null,{default:n(()=>[l(s(d),{value:t.customConfig,"onUpdate:value":e[14]||(e[14]=a=>t.customConfig=a),type:"textarea",placeholder:'{"key":"value"}',autosize:{minRows:4,maxRows:8}},null,8,["value"])]),_:1})])):P("",!0)]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])]))}},Se=h(ke,[["__scopeId","data-v-fa435bbc"]]);export{Se as default};
