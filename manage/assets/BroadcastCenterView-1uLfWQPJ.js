import{s as q,a as A}from"./admin-BtnSuRvZ.js";import{a as H}from"./dashboard-Ks6BhIBF.js";import{_ as L,u as U,r as w,a as E,o as R,v as j,c as f,e as n,w as o,f as r,N as M,h as p,i as s,B as g,p as b,j as O,l as x,m as C,H as $,I as z,z as F,t as i}from"./index-bpa48Sxk.js";import{d as P,f as G}from"./formatters-CqQpRoa5.js";import{u as J}from"./use-message-CHqbSZtC.js";const K={class:"broadcast-view"},Q={class:"card-header"},W={class:"actions"},X={class:"form-grid"},Z={class:"form-actions"},ee={class:"card-header"},te={class:"filter-group"},se=["onClick"],ae={key:0,class:"news-list"},le={class:"meta"},ne={key:1,class:"empty-state"},re={__name:"BroadcastCenterView",setup(oe){const v=U(),u=J(),h=w(!1),N=w(!1),k=w([]),m=w("all"),l=E({title:"",content:"",days:3}),I=[{label:"全部",value:"all"},{label:"系统",value:"sys"},{label:"账户",value:"user"},{label:"族群",value:"dna"}];R(()=>{y(),v.status||v.fetchStatus?.()});async function y(){h.value=!0;try{const a=await H();k.value=S(a.data)}catch(a){const e=a?.response?.data?.message||a?.message||"加载通知失败";u.error(e)}finally{h.value=!1}}function S(a={}){const e=[],t=(d=[],c)=>{d.forEach(_=>{e.push({..._,id:_.id||`${c}-${_.created_at}`,type:c,typeLabel:c==="sys"?"系统":c==="user"?"账户":"族群",expireText:P(_.expires_at)})})};return t(a.sys_news,"sys"),t(a.user_news,"user"),t(a.dna_news,"dna"),e.sort((d,c)=>new Date(c.created_at)-new Date(d.created_at))}const D=j(()=>m.value==="all"?k.value:k.value.filter(a=>a.type===m.value));function T(a){return G(a,"YYYY-MM-DD HH:mm")}function B(){l.title="",l.content="",l.days=3}async function V(){if(!l.title||!l.content){u.warning("请填写完整的标题和内容");return}const a=v.status||await v.fetchStatus?.();if(!a?.dna||!a?.id){u.error("无法获取 DNA 信息，刷新后重试");return}const e=`${a.dna}${a.id}.`;N.value=!0;try{await q(e,{title:l.title.trim(),content:l.content.trim(),days:Number(l.days)||3}),u.success("通知已发送"),B(),await y()}catch(t){const d=t?.response?.data?.message||t?.message||"发送失败";u.error(d)}finally{N.value=!1}}async function Y(a){if(window.confirm(`确定删除通知「${a.title}」吗？`))try{await A(a.id),u.success("通知已删除"),await y()}catch(e){const t=e?.response?.data?.message||e?.message||"删除失败";u.error(t)}}return(a,e)=>(p(),f("section",K,[n(r(M),{class:"compose-card",bordered:!1},{default:o(()=>[s("header",Q,[e[4]||(e[4]=s("div",null,[s("h2",null,"广播通知"),s("p",null,"向 DNA 全体用户推送公告，可设置过期时间。")],-1)),s("div",W,[n(r(g),{secondary:"",size:"small",loading:h.value,onClick:y},{default:o(()=>[...e[3]||(e[3]=[b("刷新列表",-1)])]),_:1},8,["loading"])])]),n(r(O),{"label-placement":"top",model:l},{default:o(()=>[s("div",X,[n(r(x),{label:"标题",required:""},{default:o(()=>[n(r(C),{value:l.title,"onUpdate:value":e[0]||(e[0]=t=>l.title=t),placeholder:"通知标题"},null,8,["value"])]),_:1}),n(r(x),{label:"有效天数",required:""},{default:o(()=>[n(r(C),{value:l.days,"onUpdate:value":e[1]||(e[1]=t=>l.days=t),type:"number",min:"1",max:"30"},null,8,["value"])]),_:1})]),n(r(x),{label:"正文",required:""},{default:o(()=>[n(r(C),{value:l.content,"onUpdate:value":e[2]||(e[2]=t=>l.content=t),type:"textarea",autosize:{minRows:6,maxRows:12},placeholder:"支持 Markdown 简要格式"},null,8,["value"])]),_:1})]),_:1},8,["model"]),s("div",Z,[n(r(g),{type:"primary",loading:N.value,onClick:V},{default:o(()=>[...e[5]||(e[5]=[b("发送通知",-1)])]),_:1},8,["loading"]),n(r(g),{tertiary:"",onClick:B},{default:o(()=>[...e[6]||(e[6]=[b("清空",-1)])]),_:1})])]),_:1}),n(r(M),{class:"news-card",bordered:!1},{default:o(()=>[s("header",ee,[e[7]||(e[7]=s("div",null,[s("h3",null,"通知列表"),s("p",null,"包含系统、账户、族群三类通知，按时间倒序排列。")],-1)),s("div",te,[(p(),f($,null,z(I,t=>s("button",{key:t.value,type:"button",class:F(["type-chip",{active:m.value===t.value}]),onClick:d=>m.value=t.value},i(t.label),11,se)),64))])]),D.value.length?(p(),f("div",ae,[(p(!0),f($,null,z(D.value,t=>(p(),f("article",{key:t.id,class:"news-item"},[s("header",null,[s("div",null,[s("span",{class:F(["type",`type--${t.type}`])},i(t.typeLabel),3),s("h4",null,i(t.title),1)]),s("div",le,[s("time",null,i(T(t.created_at)),1),s("span",null,i(t.expireText),1)])]),s("p",null,i(t.content),1),s("footer",null,[s("span",null,"发送者："+i(t.created_by||"系统"),1),n(r(g),{text:"",size:"small",type:"error",onClick:d=>Y(t)},{default:o(()=>[...e[8]||(e[8]=[b("删除",-1)])]),_:1},8,["onClick"])])]))),128))])):(p(),f("div",ne,[...e[9]||(e[9]=[s("p",null,"暂无通知，发送后将显示在此。",-1)])]))]),_:1})]))}},pe=L(re,[["__scopeId","data-v-c161d863"]]);export{pe as default};
