import{_ as V,u as T,r as y,v as B,c as A,e as a,w as s,f as l,N as P,L as F,b as Y,h as I,i as t,j as D,l as S,m as E,n as U,B as _,p as v,W as k,t as j,D as q,y as H,P as L,Y as x,Z as O,$ as W}from"./index-bpa48Sxk.js";import{a as $}from"./accounts-DmvIR8TI.js";import{u as z}from"./useNotifications-BAmmmttN.js";import{C as Z}from"./CopyOutline-Cp_FYSuT.js";import{u as G}from"./use-message-CHqbSZtC.js";import"./dashboard-Ks6BhIBF.js";const J={class:"account-reset-view"},Q={class:"reset-result-content"},X={class:"key-display-section"},ee={class:"key-display-value"},te={style:{margin:"8px 0","padding-left":"20px"}},ae={key:0},se={class:"modal-footer"},le={__name:"AccountResetView",setup(oe){const R=Y(),o=G(),f=T(),{stopPolling:C,startPolling:g}=z(),n=y({apiKey:""}),c=y(!1),m=y(!1),d=y(""),K=y(""),N=B(()=>K.value===f.apiKey);async function b(){const r=n.value.apiKey?.trim();if(!r){o.error("请输入 API Key");return}if(!r.startsWith("sk-")){o.error("API Key 格式不正确，应以 sk- 开头");return}c.value=!0,K.value=r;const e=r===f.apiKey;e&&(C(),W());try{const w=`${L().format("YYYY-MM-DD")}-ROTATE-SELF`,u=await $(r,w),p=u?.data?.SecretKey||u?.data?.secret_key||u?.data?.NewSecretKey||u?.data?.Key||u?.data?.key||u?.data?.data?.SecretKey||"";if(!p){o.warning("接口未返回新密钥，请联系管理员"),c.value=!1,e&&(x(),g(6e4));return}e&&(f.apiKey=p,localStorage.setItem("dawapi:api-key",p),O(p),x(),g(6e4)),d.value=p,m.value=!0,n.value.apiKey=""}catch(i){const w=i?.response?.data?.message||i?.message||"重置失败";o.error(w),e&&(x(),g(6e4))}finally{c.value=!1}}async function h(){if(!d.value){o.warning("暂无可复制的密钥");return}try{await navigator.clipboard.writeText(d.value),o.success("密钥已复制到剪贴板")}catch{o.error("复制失败，请手动复制")}}function M(){m.value=!1,N.value&&(o.success("密钥已重置，请使用新密钥重新登录"),f.logout(),R.replace({name:"login",query:{reason:"reset"}})),d.value="",K.value=""}return(r,e)=>(I(),A("section",J,[a(l(P),{class:"header-card",bordered:!1},{default:s(()=>[...e[2]||(e[2]=[t("div",{class:"header-content"},[t("div",{class:"header-info"},[t("h2",null,"账户重置管理"),t("p",null,"输入 API Key 重置对应账户的密钥，可用于重置自己或子账户的访问凭证")])],-1)])]),_:1}),a(l(P),{class:"reset-card",bordered:!1},{default:s(()=>[a(l(D),{ref:"resetFormRef",model:n.value,"label-placement":"top"},{default:s(()=>[a(l(S),{label:"目标账户 API Key",required:""},{default:s(()=>[a(l(E),{value:n.value.apiKey,"onUpdate:value":e[0]||(e[0]=i=>n.value.apiKey=i),type:"text",placeholder:"请输入需要重置的账户 API Key (sk-...)",clearable:"",onKeyup:U(b,["enter"])},null,8,["value"])]),_:1}),a(l(S),null,{default:s(()=>[a(l(_),{type:"primary",loading:c.value,disabled:!n.value.apiKey?.trim(),onClick:b,style:{width:"200px"}},{default:s(()=>[...e[3]||(e[3]=[v(" 重置密钥 ",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["model"]),a(l(k),{type:"warning",title:"安全提示",style:{"margin-top":"24px"}},{default:s(()=>[...e[4]||(e[4]=[t("ul",{style:{margin:"8px 0","padding-left":"20px"}},[t("li",null,"重置后，原密钥将立即失效，请确保已通知账户所有者"),t("li",null,"新密钥仅显示一次，请务必妥善保存"),t("li",null,"如果重置的是自己的账户，完成后需要使用新密钥重新登录")],-1)])]),_:1})]),_:1}),a(l(F),{show:m.value,"onUpdate:show":e[1]||(e[1]=i=>m.value=i),preset:"card",title:"密钥重置成功",size:"medium","mask-closable":!1,style:{"max-width":"600px"}},{footer:s(()=>[t("div",se,[a(l(_),{type:"primary",onClick:M},{default:s(()=>[...e[10]||(e[10]=[v(" 我已保存，关闭窗口 ",-1)])]),_:1})])]),default:s(()=>[t("div",Q,[a(l(k),{type:"success",title:"重置成功"},{default:s(()=>[...e[5]||(e[5]=[v(" 账户密钥已成功重置，请妥善保存以下新密钥。密钥仅显示一次，关闭后无法再次查看。 ",-1)])]),_:1}),t("div",X,[e[7]||(e[7]=t("div",{class:"key-label"},"新密钥",-1)),t("div",ee,j(d.value),1),a(l(_),{type:"primary",onClick:h,style:{"margin-top":"12px"}},{icon:s(()=>[a(l(q),null,{default:s(()=>[a(l(Z))]),_:1})]),default:s(()=>[e[6]||(e[6]=v(" 复制密钥 ",-1))]),_:1})]),a(l(k),{type:"warning","show-icon":!1,style:{"margin-top":"20px"}},{default:s(()=>[t("ul",te,[e[8]||(e[8]=t("li",null,"请立即复制并保存此密钥",-1)),e[9]||(e[9]=t("li",null,"密钥关闭后无法再次查看",-1)),N.value?(I(),A("li",ae,"重置的是您自己的账户，关闭后将自动退出登录")):H("",!0)])]),_:1})])]),_:1},8,["show"])]))}},ye=V(le,[["__scopeId","data-v-7fc8716f"]]);export{ye as default};
